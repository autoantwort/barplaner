include:
  - src/vue3-client/.gitlab-ci.yml

stages:
  - format
  - pages
  - build
  - test
  - deploy-production

# From https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#buildah-example
.template: &build_template
  stage: build
  image: quay.io/buildah/stable
  variables:
    # Use vfs with buildah. Docker offers overlayfs as a default, but Buildah
    # cannot stack overlayfs on top of another overlayfs filesystem.
    STORAGE_DRIVER: vfs
  before_script:
    # GitLab container registry credentials taken from the predefined CI/CD variables
    # to authenticate to the registry.
    - echo "$CI_REGISTRY_PASSWORD" | buildah login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - |
      if [[ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]]; then
        tag=":latest"
        echo "Running on default branch '$CI_DEFAULT_BRANCH': tag = 'latest'"
      else
        tag=":$CI_COMMIT_REF_SLUG"
        echo "Running on branch '$CI_COMMIT_BRANCH': tag = $tag"
      fi
    - buildah images
    - buildah build -t "$CI_REGISTRY_IMAGE$IMAGE_NAME${tag}" -f $DOCKERFILE_NAME $DOCKERFILE_DIR
    - buildah images
    - buildah push "$CI_REGISTRY_IMAGE$IMAGE_NAME${tag}"
  # rules:
  #   - exists:
  #       - src/Dockerfile-vue3
  #     when: always


build:vue-frontend:
  <<: *build_template
  variables:
    IMAGE_NAME: ""
    DOCKERFILE_NAME: Dockerfile-vue3
    DOCKERFILE_DIR: src

build:bun-backend:
  <<: *build_template
  variables:
    IMAGE_NAME: /bun-backend
    DOCKERFILE_NAME: Dockerfile
    DOCKERFILE_DIR: src/Nodejs-RestAPIs

test-backend:
  stage: test
  image: curlimages/curl
  script:
    - |
      if [[ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]]; then
        tag=":latest"
        echo "Running on default branch '$CI_DEFAULT_BRANCH': tag = 'latest'"
      else
        tag=":$CI_COMMIT_REF_SLUG"
        echo "Running on branch '$CI_COMMIT_BRANCH': tag = $tag"
      fi
    - docker run -d --name backend-test $CI_REGISTRY_IMAGE/bun-backend:${tag}
    - sleep 10 # wait for the backend to start
    - curl --fail http://localhost:3000/health || (docker logs backend-test && exit 1)
    - docker stop backend-test
    - docker rm backend-test


deploy-production:
  image: curlimages/curl
  stage: deploy-production
  script:
    - curl -X POST --fail https://portainer.hilton.rwth-aachen.de/api/webhooks/ee27c453-3826-40ce-bde7-1ae896e2d4a3

